<html lang="ko">
{% include 'head.html' %}
<head>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/upload.css" />
</head>
<body>
<div id="summ-upload">
    <h1>â¤ï¸ AIê°€ ë‹¹ì‹ ì˜ ì¸ì„ ê°ì§€í–ˆìŠµë‹ˆë‹¤ â¤ï¸</h1>

    <textarea id="textInput" rows="6" placeholder="ëŒ€í™” ì…ë ¥ ë˜ëŠ” ì´ë¯¸ì§€ ë“œë˜ê·¸" @input="onInput"></textarea>

    <div id="dropArea"
         @click="triggerFile"
         @dragover.prevent
         @drop="onDrop">
        <!-- ğŸ”‘ name="file" ê¼­ í•„ìš”í•¨ -->
        <input type="file" id="imageInput" name="file" hidden @change="onFileChange" />
        <button type="button">íŒŒì¼ ì—…ë¡œë“œ</button>
    </div>

    <img id="preview" />

    <button class="submit" @click="submit">ë¶„ì„ ì œì¶œ</button>

    <p id="loading" style="display: none;">ë¡œë”© ì¤‘...</p>
</div>

<script type="module">
    import { createApp, ref, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    createApp({
        setup() {
            const text = ref('')
            const file = ref(null)
            const previewUrl = ref('')

            const triggerFile = () => {
                document.getElementById('imageInput').click()
            }

            const onInput = (e) => {
                text.value = e.target.value
            }

            const onFileChange = (e) => {
                const f = e.target.files[0]
                if (f) handleImage(f)
            }

            const onDrop = (e) => {
                e.preventDefault()
                const f = e.dataTransfer.files[0]
                if (f) handleImage(f)
            }

            const handleImage = (f) => {
                file.value = f
                const preview = document.getElementById('preview')
                previewUrl.value = URL.createObjectURL(f)
                preview.src = previewUrl.value

                Tesseract.recognize(f, 'kor', {
                    logger: m => console.log(m)
                }).then(({ data: { text: result } }) => {
                    text.value = result
                 //   document.getElementById('textInput').value = result
                })
            }

            const submit = async () => {
                if (!text.value.trim() && !file.value) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.')
                    return
                }

                const form = new FormData()
                if (text.value) form.append('text', text.value)
                if (file.value) form.append('file', file.value)

                const loadingEl = document.getElementById('loading')
                loadingEl.style.display = 'block'

                try {
                    const res = await axios.post('/api/upload', form)
                    alert('ì—…ë¡œë“œ ì„±ê³µ! ğŸ‰')
                   // location.href = `/summ/result/${res.data.result_id}` // ë¶„ì„ í˜ì´ì§€ ì´ë™
                } catch {
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨')
                } finally {
                    loadingEl.style.display = 'none'
                }
            }

            return {
                triggerFile,
                onInput,
                onFileChange,
                onDrop,
                submit
            }
        }
    }).mount('#summ-upload')
</script>
</body>
</html>